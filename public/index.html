<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Forecast</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --accent: #f97316;
        --accent-2: #2563eb;
        --border: #e2e8f0;
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        --hero: linear-gradient(135deg, #1f8ae0 0%, #0c66c2 100%);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        color: var(--text);
        min-height: 100vh;
        background: linear-gradient(180deg, #f8fbff 0%, #eef4fb 100%);
        position: relative;
        overflow-x: hidden;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background:
          radial-gradient(circle at 12% 14%, rgba(147, 197, 253, 0.35) 0 170px, transparent 230px),
          radial-gradient(circle at 28% 20%, rgba(191, 219, 254, 0.35) 0 200px, transparent 260px),
          radial-gradient(circle at 78% 16%, rgba(147, 197, 253, 0.32) 0 190px, transparent 250px),
          radial-gradient(circle at 88% 32%, rgba(191, 219, 254, 0.32) 0 220px, transparent 290px),
          radial-gradient(circle at 18% 78%, rgba(147, 197, 253, 0.3) 0 240px, transparent 320px),
          radial-gradient(circle at 76% 76%, rgba(191, 219, 254, 0.3) 0 260px, transparent 340px);
        opacity: 0.9;
        filter: blur(1px);
      }
      main.app {
        max-width: 1120px;
        margin: 0 auto;
        padding: 28px 20px 48px;
      }
      body .auth-controls {
        position: fixed;
        top: 18px;
        right: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        z-index: 5;
      }
      @media (max-width: 720px) {
        body .auth-controls {
          top: 12px;
          right: 12px;
        }
      }
      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 22px;
        position: relative;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: #0ea5e9;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }
      .brand-text {
        display: flex;
        flex-direction: column;
      }
      .brand-title {
        font-size: 18px;
        font-weight: 700;
      }
      .brand-subtitle {
        font-size: 12px;
        color: var(--muted);
      }
      .header-actions {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        justify-content: flex-end;
      }
      .auth-controls {
        position: fixed;
      }
      .auth-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border);
        display: none;
        background: #f1f5f9;
        box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
      }
      .auth-avatar-fallback {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid var(--border);
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: #1f2937;
        background: #e2e8f0;
        box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
      }
      .auth-user {
        font-size: 12px;
        color: var(--muted);
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: none;
      }
      .auth-button {
        background: #ffffff;
        border: 1px solid var(--border);
        color: var(--text);
        min-width: auto;
        height: 28px;
        padding: 4px 10px;
        font-size: 12px;
        box-shadow: none;
      }
      .lang-tabs {
        display: inline-flex;
        gap: 8px;
        padding: 4px;
        border-radius: 999px;
        background: transparent;
        box-shadow: none;
      }
      .lang-tabs button {
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        line-height: 1;
        height: 24px;
        min-width: 36px;
        border-radius: 999px;
        cursor: pointer;
        color: #64748b;
        box-shadow: none;
      }
      #lang-he {
        font-size: 12px;
      }
      .lang-tabs button.active {
        background: #1f8ae0;
        border-color: #1f8ae0;
        color: white;
      }
      .search-card {
        background: var(--card);
        border-radius: 18px;
        padding: 16px 20px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .search-form {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)) auto;
        gap: 14px;
        align-items: center;
      }
      .search-form .field:last-child {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 18px;
      }
      .field label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--muted);
      }
      input {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #f8fafc;
      }
      .dropdown {
        position: relative;
      }
      .dropdown input {
        padding-right: 34px;
      }
      .dropdown .chevron {
        position: absolute;
        right: 12px;
        top: 33px;
        color: var(--muted);
        pointer-events: none;
      }
      body[dir="rtl"] .dropdown .chevron {
        right: auto;
        left: 12px;
      }
      .dropdown-list {
        position: absolute;
        z-index: 10;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-top: 6px;
        max-height: 220px;
        overflow-y: auto;
        width: 100%;
        box-shadow: var(--shadow);
        display: none;
      }
      .dropdown-list.open {
        display: block;
      }
      .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
      }
      .dropdown-item:hover,
      .dropdown-item.active {
        background: #eff6ff;
      }
      button {
        padding: 8px 16px;
        font-size: 13px;
        border: none;
        border-radius: 12px;
        background: #d97035;
        color: white;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.2s ease;
        box-shadow: none;
        min-width: 120px;
        height: 34px;
      }
      button.cta {
        border-radius: 999px;
        padding: 8px 18px;
        box-shadow: none;
      }
      button:active {
        transform: translateY(1px);
      }
      .status {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }
      .hero-card {
        margin-top: 22px;
        background: var(--hero);
        color: white;
        border-radius: 22px;
        padding: 24px 28px;
        box-shadow: var(--shadow);
        position: relative;
      }
      .hero-card.hidden {
        display: none;
      }
      .hero-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
      }
      .hero-city {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
      }
      .hero-country {
        margin: 4px 0;
        font-size: 14px;
        opacity: 0.8;
      }
      .hero-date .today-pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 600;
        font-size: 12px;
      }
      .hero-date {
        margin: 4px 0 0;
      }
      .hero-condition {
        margin: 16px 0 0;
        font-size: 14px;
        font-weight: 600;
      }
      .hero-temp {
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      body[dir="rtl"] .hero-temp {
        text-align: left;
        align-items: flex-start;
      }
      .hero-icon {
        font-size: 24px;
      }
      .hero-temp-value {
        font-size: 52px;
        font-weight: 700;
        line-height: 1;
      }
      .hero-temp-sub {
        font-size: 13px;
        opacity: 0.8;
      }
      .hero-stats {
        margin-top: 18px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.16);
        border-radius: 14px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
      }
      .stat-card span {
        opacity: 0.75;
      }
      .stat-card strong {
        font-size: 15px;
        font-weight: 600;
      }
      .forecast-section {
        margin-top: 26px;
      }
      .forecast-section.hidden {
        display: none;
      }
      .section-header h2 {
        margin: 0;
        font-size: 20px;
      }
      .section-header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }
      .forecast-grid {
        margin-top: 16px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 14px;
      }
      .forecast-table {
        margin-top: 16px;
        display: none;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      }
      .forecast-table table {
        width: 100%;
        border-collapse: collapse;
        min-width: 100%;
      }
      .forecast-table th,
      .forecast-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }
      .forecast-table th {
        background: #f1f5ff;
        color: var(--muted);
        font-weight: 600;
        text-transform: none;
      }
      .forecast-table tbody tr {
        background: white;
      }
      .forecast-table tbody tr:nth-child(odd) {
        background: #f8fbff;
      }
      .forecast-table td {
        color: #0f172a;
      }
      .forecast-cell-day {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-weight: 600;
      }
      .forecast-cell-day span {
        font-size: 11px;
        color: var(--muted);
        font-weight: 500;
      }
      .forecast-cell-weather {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .forecast-cell-weather span {
        font-size: 11px;
        color: var(--muted);
      }
      .forecast-temp-main {
        font-weight: 600;
      }
      .forecast-temp-sub {
        font-size: 11px;
        color: var(--muted);
      }
      body[dir="rtl"] .forecast-table th,
      body[dir="rtl"] .forecast-table td {
        text-align: right;
      }
      .forecast-card {
        background: var(--card);
        border-radius: 16px;
        padding: 14px 12px;
        border: 1px solid var(--border);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06);
        text-align: center;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      .forecast-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      }
      .forecast-card.today {
        border-color: #1d4ed8;
        background: linear-gradient(180deg, #0ea5e9 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.3);
      }
      .forecast-card.today .forecast-day,
      .forecast-card.today .forecast-date,
      .forecast-card.today .forecast-desc {
        color: rgba(255, 255, 255, 0.85);
      }
      .forecast-day {
        font-size: 12px;
        color: var(--muted);
      }
      .forecast-date {
        font-size: 12px;
        margin-top: 4px;
        color: var(--muted);
      }
      .forecast-icon {
        margin: 14px 0;
        font-size: 22px;
      }
      .forecast-temp {
        font-size: 18px;
        font-weight: 600;
      }
      .forecast-desc {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .forecast-rain {
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }
      .forecast-card.today .forecast-rain {
        color: rgba(255, 255, 255, 0.85);
      }
      .app-footer {
        margin-top: 30px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: center;
        text-align: center;
      }
      .footer-card {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 18px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        min-width: 240px;
      }
      .footer-brand {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: var(--text);
      }
      .footer-brand .brand-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
      .footer-meta {
        font-size: 12px;
        color: var(--muted);
      }
      .footer-links {
        display: inline-flex;
        gap: 8px;
        color: var(--muted);
        font-size: 11px;
      }
      body[dir="rtl"] main.app {
        direction: rtl;
      }
      body[dir="rtl"] .footer-links {
        direction: rtl;
      }
      @media (max-width: 900px) {
        .hero-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .app-footer {
          flex-direction: column;
          gap: 6px;
        }
      }
      @media (max-width: 720px) {
        main.app {
          padding: 20px 16px 36px;
        }
        .app-header {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }
        .search-form {
          grid-template-columns: 1fr;
        }
        button {
          width: 100%;
        }
        .hero-main {
          flex-direction: row;
          align-items: flex-start;
          justify-content: space-between;
          gap: 16px;
        }
        .hero-temp {
          align-items: flex-end;
          text-align: right;
        }
        body[dir="rtl"] .hero-temp {
          align-items: flex-start;
          text-align: left;
        }
        .forecast-grid {
          display: none;
        }
        .forecast-table {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <header class="app-header">
        <div class="brand">
          <div class="brand-icon">üå¶Ô∏è</div>
          <div class="brand-text">
            <span class="brand-title" id="brand-title">Weather</span>
            <span class="brand-subtitle" id="brand-subtitle">7-day forecast</span>
          </div>
        </div>
        <div class="header-actions">
          <div class="lang-tabs" role="tablist" aria-label="Language">
            <button id="lang-en" type="button" role="tab" aria-selected="true" class="active">
              EN
            </button>
            <button id="lang-he" type="button" role="tab" aria-selected="false">
              ◊¢◊ë
            </button>
          </div>
          <div class="auth-controls">
            <img id="auth-avatar" class="auth-avatar" alt="" referrerpolicy="no-referrer" />
            <span id="auth-avatar-fallback" class="auth-avatar-fallback"></span>
            <span id="auth-user" class="auth-user"></span>
            <button id="auth-login" type="button" class="auth-button">Sign in</button>
            <button id="auth-logout" type="button" class="auth-button" hidden>Sign out</button>
          </div>
        </div>
      </header>

      <section class="search-card">
        <form id="forecast-form" class="search-form">
          <div class="field">
            <label for="country-search">Country</label>
            <div class="dropdown">
              <input
                id="country-search"
                placeholder="Type at least 2 letters"
                required
                autocomplete="off"
              />
              <span class="chevron">‚ñæ</span>
              <div id="country-list" class="dropdown-list"></div>
            </div>
          </div>
          <div class="field">
            <label for="city-search">City</label>
            <div class="dropdown">
              <input
                id="city-search"
                placeholder="Select a country first"
                disabled
                autocomplete="off"
              />
              <span class="chevron">‚ñæ</span>
              <div id="city-list" class="dropdown-list"></div>
            </div>
          </div>
          <div class="field">
            <button type="submit" class="cta">Get Forecast</button>
          </div>
        </form>
        <div id="status" class="status"></div>
      </section>

      <section class="hero-card hidden" id="hero-card">
        <div class="hero-main">
          <div>
            <div class="hero-date" id="hero-date">
              <span class="today-pill">--</span>
            </div>
            <h1 class="hero-city" id="hero-city">--</h1>
            <p class="hero-country" id="hero-country">--</p>
            <p class="hero-condition" id="hero-condition">--</p>
          </div>
          <div class="hero-temp">
            <div class="hero-icon" id="hero-icon">‚õÖ</div>
            <div class="hero-temp-value" id="hero-temp">--</div>
            <div class="hero-temp-sub" id="hero-temp-sub">--</div>
          </div>
        </div>
        <div class="hero-stats" id="hero-stats"></div>
      </section>

      <section class="forecast-section hidden" id="forecast-section">
        <div class="section-header">
          <h2 id="forecast-title">7-Day Forecast</h2>
          <p id="forecast-subtitle">Weather outlook for your location.</p>
        </div>
        <div id="result" class="forecast-grid"></div>
        <div id="forecast-table" class="forecast-table"></div>
      </section>

      <footer class="app-footer" id="footer-note">
        <div class="footer-card">
          <div class="footer-brand">
            <span class="brand-icon">üå¶Ô∏è</span>
            <span id="footer-title">Weather Forecast</span>
          </div>
          <div class="footer-meta" id="footer-created">Created by Tzachi Cohen</div>
          <div class="footer-meta" id="footer-rights">All Rights Reserved 2026</div>
          <div class="footer-links">
            <span id="footer-privacy">Privacy Policy</span>
            <span>‚Ä¢</span>
            <span id="footer-terms">Terms of Service</span>
            <span>‚Ä¢</span>
            <span id="footer-contact">Contact</span>
          </div>
        </div>
      </footer>

    </main>

    <script>
      const form = document.getElementById("forecast-form");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const heroCard = document.getElementById("hero-card");
      const heroCityEl = document.getElementById("hero-city");
      const heroCountryEl = document.getElementById("hero-country");
      const heroDateEl = document.getElementById("hero-date");
      const heroConditionEl = document.getElementById("hero-condition");
      const heroTempEl = document.getElementById("hero-temp");
      const heroTempSubEl = document.getElementById("hero-temp-sub");
      const heroIconEl = document.getElementById("hero-icon");
      const heroStatsEl = document.getElementById("hero-stats");
      const forecastSection = document.getElementById("forecast-section");
      const forecastTitleEl = document.getElementById("forecast-title");
      const forecastSubtitleEl = document.getElementById("forecast-subtitle");
      const forecastTableEl = document.getElementById("forecast-table");
      const brandTitleEl = document.getElementById("brand-title");
      const brandSubtitleEl = document.getElementById("brand-subtitle");
      const footerTitleEl = document.getElementById("footer-title");
      const footerCreatedEl = document.getElementById("footer-created");
      const footerRightsEl = document.getElementById("footer-rights");
      const footerPrivacyEl = document.getElementById("footer-privacy");
      const footerTermsEl = document.getElementById("footer-terms");
      const footerContactEl = document.getElementById("footer-contact");
      const authAvatarEl = document.getElementById("auth-avatar");
      const authAvatarFallbackEl = document.getElementById("auth-avatar-fallback");
      const authUserEl = document.getElementById("auth-user");
      const authLoginButton = document.getElementById("auth-login");
      const authLogoutButton = document.getElementById("auth-logout");
      const langEnButton = document.getElementById("lang-en");
      const langHeButton = document.getElementById("lang-he");
      const countrySearch = document.getElementById("country-search");
      const countryList = document.getElementById("country-list");
      const citySearch = document.getElementById("city-search");
      const cityList = document.getElementById("city-list");

      let allCountries = [];
      let selectedCountryCode = "";
      let selectedCityName = "";
      let locationDefaults = null;
      let rawLocationDefaults = null;
      let locationDenied = false;
      let autoSubmitPending = false;
      let labels = {};
      const SESSION_KEY = "weatherPreferences";
      const PERSISTED_STORAGE = window.localStorage;

      function getDefaultLanguage() {
        const locale = (navigator.language || "").toLowerCase();
        const locales = Array.isArray(navigator.languages) ? navigator.languages : [];
        const combined = [locale, ...locales].join(",").toLowerCase();
        if (combined.includes("he") || combined.includes("he-il")) {
          return "he";
        }
        try {
          const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          if (timeZone && timeZone.toLowerCase() === "asia/jerusalem") {
            return "he";
          }
        } catch (error) {
          console.warn("Unable to detect time zone for language default:", error);
        }
        return "en";
      }

      let selectedLanguage = "en";

      async function loadLabels(lang) {
        try {
          const response = await fetch(`/i18n/${lang}.json`);
          if (!response.ok) {
            throw new Error("Failed to load labels");
          }
          labels = await response.json();
        } catch (error) {
          if (lang !== "en") {
            return loadLabels("en");
          }
          labels = {};
        }
      }

      function readSessionDefaults() {
        try {
          const raw = PERSISTED_STORAGE.getItem(SESSION_KEY);
          if (!raw) {
            return null;
          }
          const data = JSON.parse(raw);
          if (!data || typeof data !== "object") {
            return null;
          }
          return {
            lang: typeof data.lang === "string" ? data.lang : null,
            countryCode: typeof data.countryCode === "string" ? data.countryCode : null,
            countryName: typeof data.countryName === "string" ? data.countryName : null,
            cityName: typeof data.cityName === "string" ? data.cityName : null,
            admin1: typeof data.admin1 === "string" ? data.admin1 : null,
          };
        } catch (error) {
          console.warn("Unable to read session defaults:", error);
          return null;
        }
      }

      function writeSessionDefaults(update) {
        try {
          const current = readSessionDefaults() || {};
          const next = { ...current, ...update };
          PERSISTED_STORAGE.setItem(SESSION_KEY, JSON.stringify(next));
        } catch (error) {
          console.warn("Unable to save session defaults:", error);
        }
      }

      function t(key, vars = {}) {
        const template = labels[key] ?? key;
        return Object.keys(vars).reduce(
          (result, name) => result.replaceAll(`{${name}}`, String(vars[name])),
          template,
        );
      }

      function pickClosestResult(results, latitude, longitude) {
        if (!Array.isArray(results) || results.length === 0) {
          return null;
        }
        let best = results[0];
        let bestScore = Number.POSITIVE_INFINITY;
        results.forEach((result) => {
          if (typeof result.latitude !== "number" || typeof result.longitude !== "number") {
            return;
          }
          const dLat = result.latitude - latitude;
          const dLon = result.longitude - longitude;
          const score = dLat * dLat + dLon * dLon;
          if (score < bestScore) {
            bestScore = score;
            best = result;
          }
        });
        return best;
      }

      async function getGeoDefaults() {
        if (!navigator.geolocation) {
          return null;
        }

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              (async () => {
                try {
                  const response = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&count=5&language=en&format=json`,
                  );
                  const data = await response.json();
                  const hit = pickClosestResult(data?.results, latitude, longitude);
                  if (!hit) {
                    resolve(null);
                    return;
                  }
                  resolve({
                    countryCode: hit.country_code?.toUpperCase() || "",
                    countryName: hit.country || "",
                    cityName: hit.name || "",
                    admin1: hit.admin1 ?? null,
                    accuracy: position.coords.accuracy ?? null,
                    source: "geo",
                  });
                } catch (error) {
                  console.warn("Unable to reverse geocode location:", error);
                  resolve(null);
                }
              })();
            },
            (error) => {
              if (error && error.code === 1) {
                locationDenied = true;
              }
              console.warn("Geolocation not available:", error);
              resolve(null);
            },
            { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 },
          );
        });
      }

      async function fetchJsonWithTimeout(url, timeoutMs = 8000) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), timeoutMs);
        try {
          const response = await fetch(url, { signal: controller.signal });
          return await response.json();
        } catch (error) {
          return null;
        } finally {
          clearTimeout(timeout);
        }
      }

      async function getIpDefaults() {
        try {
          let data = await fetchJsonWithTimeout("https://ipapi.co/json/");
          if (!data || data.error) {
            data = await fetchJsonWithTimeout("https://ipwho.is/");
          }
          if (!data) {
            return null;
          }
          const latitude =
            typeof data.latitude === "number"
              ? data.latitude
              : typeof data.lat === "number"
                ? data.lat
                : null;
          const longitude =
            typeof data.longitude === "number"
              ? data.longitude
              : typeof data.lon === "number"
                ? data.lon
                : null;
          if (latitude !== null && longitude !== null) {
            const reverseUrl = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&count=5&language=en&format=json`;
            const reverseData = await fetchJsonWithTimeout(reverseUrl, 8000);
            const hit = pickClosestResult(reverseData?.results, latitude, longitude);
            if (hit) {
              return {
                countryCode: hit.country_code?.toUpperCase() || "",
                countryName: hit.country || data.country_name || data.country || "",
                cityName: hit.name || data.city || "",
                admin1: hit.admin1 ?? data.region ?? data.region_name ?? null,
                accuracy: null,
                source: "ip-geo",
              };
            }
          }
          return {
            countryCode: data.country_code ? data.country_code.toUpperCase() : data.country_code ?? "",
            countryName: data.country_name || data.country || "",
            cityName: data.city || "",
            admin1: data.region || data.region_name || null,
            accuracy: null,
            source: "ip",
          };
        } catch (error) {
          console.warn("Unable to resolve IP location:", error);
          return null;
        }
      }

      async function localizeCityName(countryCode, cityName, lang) {
        if (!countryCode || !cityName || !lang) {
          return null;
        }
        try {
          const params = new URLSearchParams({
            name: cityName,
            count: "1",
            language: lang,
            format: "json",
            country: countryCode,
          });
          const response = await fetch(
            `https://geocoding-api.open-meteo.com/v1/search?${params.toString()}`,
          );
          const data = await response.json();
          const hit = data?.results?.[0];
          if (!hit) {
            return null;
          }
          return {
            cityName: hit.name || cityName,
            admin1: hit.admin1 ?? null,
          };
        } catch (error) {
          console.warn("Unable to localize city name:", error);
          return null;
        }
      }

      async function getLocationDefaults() {
        const geoPromise = getGeoDefaults();
        const ipPromise = getIpDefaults();
        const first = await Promise.race([geoPromise, ipPromise]);
        if (first) {
          return first;
        }
        const geoDefaults = await geoPromise;
        if (geoDefaults) {
          if (typeof geoDefaults.accuracy === "number" && geoDefaults.accuracy > 50000) {
            const ipDefaults = await ipPromise;
            return ipDefaults || geoDefaults;
          }
          return geoDefaults;
        }
        return ipPromise;
      }

      async function loadCountries() {
        try {
          const response = await fetch(
            `/api/countries?lang=${encodeURIComponent(selectedLanguage)}&refresh=1`,
          );
          const data = await response.json();
          if (!response.ok) {
            statusEl.textContent = data.error || t("error_load_countries");
            return;
          }

          const heDisplay = new Intl.DisplayNames(["he"], { type: "region" });
          const enDisplay = new Intl.DisplayNames(["en"], { type: "region" });

          allCountries = data.countries.map((country) => {
            const hebrewName = country.hebrewName || heDisplay.of(country.code);
            const englishName = country.englishName || enDisplay.of(country.code);
            return {
              ...country,
              englishName: englishName || country.name,
              hebrewName: hebrewName || country.name,
              name:
                selectedLanguage === "he"
                  ? hebrewName || country.name
                  : country.name || englishName,
            };
          });
        } catch (error) {
          console.error(error);
          statusEl.textContent = t("error_load_countries");
        }
      }

      let cityFetchController = null;

      function openList(listEl) {
        listEl.classList.add("open");
      }

      function closeList(listEl) {
        listEl.classList.remove("open");
      }

      function applyLanguage() {
        const isHebrew = selectedLanguage === "he";
        document.documentElement.lang = isHebrew ? "he" : "en";
        document.body.dir = isHebrew ? "rtl" : "ltr";

        brandTitleEl.textContent = t("brand_title");
        brandSubtitleEl.textContent = t("brand_subtitle");
        document.querySelector("label[for='country-search']").textContent = t("label_country");
        document.querySelector("label[for='city-search']").textContent = t("label_city");
        document.querySelector("button[type='submit']").textContent = t("button_submit");
        footerTitleEl.textContent = t("footer_title");
        footerCreatedEl.textContent = t("footer_created");
        footerRightsEl.textContent = t("footer_rights");
        footerPrivacyEl.textContent = t("footer_privacy");
        footerTermsEl.textContent = t("footer_terms");
        footerContactEl.textContent = t("footer_contact");
        forecastTitleEl.textContent = t("forecast_title");
        authLoginButton.textContent = t("auth_login");
        authLogoutButton.textContent = t("auth_logout");
        langEnButton.classList.toggle("active", !isHebrew);
        langHeButton.classList.toggle("active", isHebrew);
        langEnButton.setAttribute("aria-selected", String(!isHebrew));
        langHeButton.setAttribute("aria-selected", String(isHebrew));

        countrySearch.placeholder = t("placeholder_country");
        citySearch.placeholder = selectedCountryCode
          ? t("placeholder_city_type")
          : t("placeholder_city_select");
      }

      function translateWeatherCode(code) {
        const key = String(code);
        const map = labels.weather_codes || {};
        return map[key] || t("unknown");
      }

      function showAvatarFallback(text) {
        authAvatarEl.removeAttribute("src");
        authAvatarEl.alt = "";
        authAvatarEl.style.display = "none";
        authAvatarFallbackEl.textContent = text
          ? text.trim().slice(0, 1).toUpperCase()
          : "U";
        authAvatarFallbackEl.style.display = "inline-flex";
      }

      function setAuthState(user) {
        if (user) {
          authUserEl.textContent = user.displayName || user.email || t("auth_signed_in");
          if (user.photo) {
            authAvatarEl.src = user.photo;
            authAvatarEl.alt = user.displayName || user.email || t("auth_signed_in");
            authAvatarEl.style.display = "inline-block";
            authAvatarFallbackEl.style.display = "none";
            authAvatarFallbackEl.textContent = "";
          } else {
            showAvatarFallback(user.displayName || user.email);
          }
          authLoginButton.hidden = true;
          authLogoutButton.hidden = false;
        } else {
          authUserEl.textContent = "";
          authAvatarEl.removeAttribute("src");
          authAvatarEl.alt = "";
          authAvatarEl.style.display = "none";
          authAvatarFallbackEl.textContent = "";
          authAvatarFallbackEl.style.display = "none";
          authLoginButton.hidden = false;
          authLogoutButton.hidden = true;
        }
      }

      async function loadAuthState() {
        try {
          const response = await fetch("/api/auth/me");
          const data = await response.json();
          setAuthState(data?.user ?? null);
        } catch (error) {
          setAuthState(null);
        }
      }

      function weatherIcon(code) {
        if (code === 0) return "‚òÄÔ∏è";
        if (code === 1) return "üå§Ô∏è";
        if (code === 2) return "‚õÖ";
        if (code === 3) return "‚òÅÔ∏è";
        if (code === 45 || code === 48) return "üå´Ô∏è";
        if (code >= 51 && code <= 57) return "üå¶Ô∏è";
        if (code >= 61 && code <= 67) return "üåßÔ∏è";
        if (code >= 71 && code <= 77) return "üå®Ô∏è";
        if (code >= 80 && code <= 82) return "üå¶Ô∏è";
        if (code >= 85 && code <= 86) return "‚ùÑÔ∏è";
        if (code >= 95) return "‚õàÔ∏è";
        return "üå°Ô∏è";
      }

      function setCountrySelection(country) {
        countrySearch.value = `${country.name} (${country.code})`;
        selectedCountryCode = country.code;
        closeList(countryList);
        citySearch.disabled = false;
        citySearch.placeholder =
          selectedLanguage === "he" ? "◊î◊ß◊ú◊ì ◊ú◊§◊ó◊ï◊™ 2 ◊ê◊ï◊™◊ô◊ï◊™" : "Type at least 2 letters";
        citySearch.value = "";
        selectedCityName = "";
        cityList.innerHTML = "";
      }

      function setCitySelection(city) {
        citySearch.value = city.admin1 ? `${city.name} (${city.admin1})` : city.name;
        selectedCityName = city.name;
        closeList(cityList);
        if (autoSubmitPending) {
          autoSubmitPending = false;
          submitIfReady();
        }
      }

      function renderCountryList(matches) {
        countryList.innerHTML = "";
        matches.forEach((country) => {
          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.textContent = `${country.name} (${country.code})`;
          item.addEventListener("mousedown", (event) => {
            event.preventDefault();
            setCountrySelection(country);
          });
          countryList.appendChild(item);
        });
        if (matches.length > 0) {
          openList(countryList);
        } else {
          closeList(countryList);
        }
      }

      function applyLocationDefaults() {
        if (!locationDefaults) {
          return;
        }

        const { countryCode, countryName, cityName, admin1 } = locationDefaults;
        let countryMatch = null;
        if (countryCode) {
          countryMatch = allCountries.find((country) => country.code === countryCode);
        }
        if (!countryMatch && countryName) {
          const normalized = countryName.toLowerCase();
          countryMatch = allCountries.find((country) => {
            const english = country.englishName?.toLowerCase();
            const hebrew = country.hebrewName?.toLowerCase();
            return (
              country.name.toLowerCase() === normalized ||
              (english && english === normalized) ||
              (hebrew && hebrew === normalized)
            );
          });
        }
        if (countryMatch) {
          setCountrySelection(countryMatch);
        } else if (countryCode || countryName) {
          setCountrySelection({
            code: countryCode || countryName,
            name: countryName || countryCode,
            englishName: countryName || countryCode,
            hebrewName: countryName || countryCode,
          });
        }

        if (selectedCountryCode && cityName) {
          setCitySelection({ name: cityName, admin1 });
        }
      }

      function resetHero() {
        heroCityEl.textContent = "--";
        heroCountryEl.textContent = "--";
        heroDateEl.innerHTML = `<span class="today-pill">${t("today_label")}</span>`;
        heroConditionEl.textContent = "--";
        heroTempEl.textContent = "--";
        heroTempSubEl.textContent = "--";
        heroIconEl.textContent = "‚õÖ";
        heroStatsEl.innerHTML = "";
        heroCard.classList.add("hidden");
        forecastSection.classList.add("hidden");
        forecastSubtitleEl.textContent = t("forecast_subtitle_default");
      }

      function submitIfReady() {
        if (!selectedCountryCode || !selectedCityName) {
          return;
        }
        if (typeof form.requestSubmit === "function") {
          form.requestSubmit();
        } else {
          form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        }
      }


      function getCountryMatches(query) {
        const normalized = query.toLowerCase();
        return allCountries
          .filter((country) => {
            const nameMatch = country.name.toLowerCase().includes(normalized);
            const codeMatch = country.code.toLowerCase().includes(normalized);
            const englishMatch = country.englishName
              ? country.englishName.toLowerCase().includes(normalized)
              : false;
            const hebrewMatch = country.hebrewName
              ? country.hebrewName.toLowerCase().includes(normalized)
              : false;
            const altMatch = Array.isArray(country.altSpellings)
              ? country.altSpellings.some((alt) =>
                  alt.toLowerCase().includes(normalized),
                )
              : false;
            return nameMatch || codeMatch || englishMatch || hebrewMatch || altMatch;
          })
          .slice(0, 50);
      }

      let countryFetchController = null;

      async function fetchCountryMatches(query) {
        if (countryFetchController) {
          countryFetchController.abort();
        }

        countryFetchController = new AbortController();
        try {
          const params = new URLSearchParams({
            query,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/countries/search?${params.toString()}`, {
            signal: countryFetchController.signal,
          });
          const data = await response.json();
          if (!response.ok) {
            return [];
          }
          return Array.isArray(data.countries) ? data.countries : [];
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
          }
          return [];
        }
      }

      async function renderCityList(countryCode, query) {
        if (query.length < 2) {
          closeList(cityList);
          return;
        }

        if (cityFetchController) {
          cityFetchController.abort();
        }

        cityFetchController = new AbortController();
        try {
          const params = new URLSearchParams({
            country: countryCode,
            query,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/cities?${params.toString()}`, {
            signal: cityFetchController.signal,
          });
          const data = await response.json();
          if (!response.ok) {
            closeList(cityList);
            return;
          }

          cityList.innerHTML = "";
          data.cities.forEach((city) => {
            const item = document.createElement("div");
            item.className = "dropdown-item";
            item.textContent = city.admin1
              ? `${city.name} (${city.admin1})`
              : city.name;
            item.addEventListener("mousedown", (event) => {
              event.preventDefault();
              setCitySelection(city);
            });
            cityList.appendChild(item);
          });
          if (data.cities.length > 0) {
            openList(cityList);
          } else {
            closeList(cityList);
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
          }
        }
      }

      async function switchLanguage(nextLang) {
        if (nextLang === selectedLanguage) {
          return;
        }
        selectedLanguage = nextLang;
        selectedCountryCode = "";
        selectedCityName = "";
        countrySearch.value = "";
        citySearch.value = "";
        citySearch.disabled = true;
        cityList.innerHTML = "";
        countryList.innerHTML = "";
        statusEl.textContent = "";
        resultEl.innerHTML = "";
        resetHero();
        await loadLabels(selectedLanguage);
        applyLocalizedDefaults(selectedLanguage);
        if (locationDefaults?.cityName) {
          const localized = await localizeCityName(
            locationDefaults.countryCode,
            locationDefaults.cityName,
            selectedLanguage,
          );
          if (localized) {
            locationDefaults = {
              ...locationDefaults,
              cityName: localized.cityName,
              admin1: localized.admin1,
            };
          }
        }
        applyLanguage();
        await loadCountries();
        autoSubmitPending = true;
        applyLocationDefaults();
        submitIfReady();
      }

      langEnButton.addEventListener("click", () => {
        switchLanguage("en");
      });

      langHeButton.addEventListener("click", () => {
        switchLanguage("he");
      });

      authAvatarEl.addEventListener("error", () => {
        showAvatarFallback(authUserEl.textContent || "U");
      });

      authLoginButton.addEventListener("click", () => {
        window.location.href = "/api/auth/google";
      });

      authLogoutButton.addEventListener("click", async () => {
        try {
          await fetch("/api/auth/logout", { method: "POST" });
        } catch (error) {
          console.warn("Unable to log out:", error);
        } finally {
          setAuthState(null);
        }
      });

      resetHero();

      countrySearch.addEventListener("input", async (event) => {
        const query = event.target.value.trim();
        selectedCountryCode = "";
        selectedCityName = "";
        citySearch.value = "";
        citySearch.disabled = true;
        citySearch.placeholder =
          t("placeholder_city_select");
        cityList.innerHTML = "";

        if (query.length < 2) {
          closeList(countryList);
          return;
        }
        let matches = getCountryMatches(query);
        if (matches.length === 0 && selectedLanguage === "he") {
          matches = await fetchCountryMatches(query);
        }
        renderCountryList(matches);
      });

      countrySearch.addEventListener("focus", async () => {
        if (countrySearch.value.trim().length >= 2) {
          let matches = getCountryMatches(countrySearch.value.trim());
          if (matches.length === 0 && selectedLanguage === "he") {
            matches = await fetchCountryMatches(countrySearch.value.trim());
          }
          renderCountryList(matches);
        }
      });

      citySearch.addEventListener("input", (event) => {
        if (!selectedCountryCode) {
          return;
        }
        renderCityList(selectedCountryCode, event.target.value.trim());
      });

      citySearch.addEventListener("focus", () => {
        if (!selectedCountryCode) {
          return;
        }
        if (citySearch.value.trim().length >= 2) {
          renderCityList(selectedCountryCode, citySearch.value.trim());
        }
      });

      document.addEventListener("click", (event) => {
        if (!countrySearch.contains(event.target) && !countryList.contains(event.target)) {
          closeList(countryList);
        }
        if (!citySearch.contains(event.target) && !cityList.contains(event.target)) {
          closeList(cityList);
        }
      });

      closeList(countryList);
      closeList(cityList);
      function applyLocalizedDefaults(targetLang) {
        if (!rawLocationDefaults) {
          locationDefaults = null;
          return;
        }
        if (targetLang === "en") {
          locationDefaults = { ...rawLocationDefaults };
          return;
        }
        if (!rawLocationDefaults.cityName) {
          locationDefaults = { ...rawLocationDefaults };
          return;
        }
        locationDefaults = { ...rawLocationDefaults };
      }
      async function initApp() {
        const sessionDefaults = readSessionDefaults();
        if (sessionDefaults?.lang) {
          selectedLanguage = sessionDefaults.lang;
        } else {
          const detectedDefaults = await getLocationDefaults();
          rawLocationDefaults = detectedDefaults;
          if (rawLocationDefaults?.countryCode === "IL") {
            selectedLanguage = "he";
          } else {
            selectedLanguage = getDefaultLanguage();
          }
        }
        if (!rawLocationDefaults) {
          rawLocationDefaults = sessionDefaults?.countryCode
            ? {
                countryCode: sessionDefaults.countryCode || "",
                countryName: sessionDefaults.countryName || "",
                cityName: sessionDefaults.cityName || "",
                admin1: sessionDefaults.admin1 ?? null,
                accuracy: null,
                source: "session",
              }
            : await getLocationDefaults();
        }
        await loadLabels(selectedLanguage);
        applyLocalizedDefaults(selectedLanguage);
        if (locationDefaults?.cityName) {
          const localized = await localizeCityName(
            locationDefaults.countryCode,
            locationDefaults.cityName,
            selectedLanguage,
          );
          if (localized) {
            locationDefaults = {
              ...locationDefaults,
              cityName: localized.cityName,
              admin1: localized.admin1,
            };
          }
        }
        applyLanguage();
        await loadAuthState();
        await loadCountries();
        autoSubmitPending = true;
        applyLocationDefaults();
        submitIfReady();
      }
      initApp();

      function formatValue(value, suffix = "") {
        if (value === null || value === undefined || Number.isNaN(value)) {
          return t("unknown");
        }
        return `${value}${suffix}`;
      }

      function formatUnit(value, suffix = "", decimals = 0) {
        if (value === null || value === undefined || Number.isNaN(value)) {
          return t("unknown");
        }
        const numeric = typeof value === "number" ? value : Number(value);
        if (Number.isNaN(numeric)) {
          return t("unknown");
        }
        return `${numeric.toFixed(decimals)}${suffix}`;
      }

      function deriveCurrent(data) {
        const baseCurrent = data?.current && typeof data.current === "object" ? data.current : {};
        const hourly = data?.hourly;
        const currentWeather = data?.current_weather;
        if (!hourly || !Array.isArray(hourly.time)) {
          return baseCurrent;
        }
        const hourlyTimes = hourly.time;
        const currentTime = currentWeather?.time;
        let index = 0;
        if (currentTime) {
          const exactIndex = hourlyTimes.indexOf(currentTime);
          if (exactIndex >= 0) {
            index = exactIndex;
          } else {
            const currentDate = currentTime.split("T")[0];
            const dateIndex = hourlyTimes.findIndex((time) => time.startsWith(currentDate));
            if (dateIndex >= 0) {
              index = dateIndex;
            }
          }
        }
        const pickHourlyValue = (values) => {
          if (!Array.isArray(values) || values.length === 0) {
            return null;
          }
          const candidate = values[index];
          if (typeof candidate === "number") {
            return candidate;
          }
          const first = values.find((value) => typeof value === "number");
          return typeof first === "number" ? first : null;
        };
        const windspeed =
          baseCurrent.windspeed ??
          pickHourlyValue(hourly.wind_speed_10m) ??
          currentWeather?.windspeed ??
          null;
        const humidity = baseCurrent.humidity ?? pickHourlyValue(hourly.relative_humidity_2m);
        const visibility = baseCurrent.visibility ?? pickHourlyValue(hourly.visibility);
        const apparentTemperature =
          baseCurrent.apparentTemperature ?? pickHourlyValue(hourly.apparent_temperature);
        return {
          temperature: baseCurrent.temperature ?? currentWeather?.temperature ?? null,
          windspeed,
          humidity: humidity ?? null,
          visibility: visibility ?? null,
          apparentTemperature: apparentTemperature ?? null,
        };
      }

      async function fetchCurrentDetails(location) {
        if (!location?.latitude || !location?.longitude) {
          return null;
        }
        try {
          const params = new URLSearchParams({
            latitude: String(location.latitude),
            longitude: String(location.longitude),
            current_weather: "true",
            hourly: "relative_humidity_2m,visibility,apparent_temperature,wind_speed_10m",
            forecast_days: "1",
            timezone: "auto",
          });
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?${params.toString()}`,
          );
          if (!response.ok) {
            return null;
          }
          const data = await response.json();
          return deriveCurrent(data);
        } catch (error) {
          console.warn("Unable to fetch current details:", error);
          return null;
        }
      }

      function needsCurrentFallback(current) {
        if (!current) {
          return true;
        }
        return (
          current.humidity == null ||
          current.windspeed == null ||
          current.visibility == null ||
          current.apparentTemperature == null
        );
      }

      function formatDate(dateString) {
        if (!dateString) {
          return "";
        }
        const parts = dateString.split("-");
        if (parts.length !== 3) {
          return dateString;
        }
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }

      function formatDayLabel(dateString) {
        const date = new Date(`${dateString}T00:00:00`);
        const locale = selectedLanguage === "he" ? "he-IL" : "en-US";
        return date.toLocaleDateString(locale, { weekday: "short" });
      }

      function buildHero(daily, location, current) {
        const todayHigh = daily.temperature_2m_max?.[0];
        const todayLow = daily.temperature_2m_min?.[0];
        const code = daily.weathercode?.[0];
        const condition = translateWeatherCode(code);
        const isHebrew = selectedLanguage === "he";
        const currentTemp = current?.temperature ?? todayHigh;
        const feelsLike = current?.apparentTemperature ?? todayHigh;
        const humidity = current?.humidity ?? null;
        const wind = current?.windspeed ?? null;
        const visibilityMeters = current?.visibility ?? null;
        const visibilityKm =
          typeof visibilityMeters === "number" ? visibilityMeters / 1000 : null;

        heroCityEl.textContent = location?.name || "--";
        heroCountryEl.textContent = location?.country || "--";
        heroDateEl.innerHTML = `<span class="today-pill">${t("today_label")}</span>`;
        heroConditionEl.textContent = condition;
        heroIconEl.textContent = weatherIcon(code);
        heroTempEl.textContent = formatValue(currentTemp, "¬∞C");
        heroTempSubEl.textContent = t("hero_temp_sub", {
          low: formatValue(todayLow, t("unit_celsius")),
          high: formatValue(todayHigh, t("unit_celsius")),
        });

        const stats = [
          {
            label: t("label_humidity"),
            value: formatUnit(humidity, "%", 0),
          },
          {
            label: t("label_wind"),
            value: formatUnit(wind, t("unit_kmh"), 0),
          },
          {
            label: t("label_visibility"),
            value: formatUnit(visibilityKm, t("unit_km"), 0),
          },
          {
            label: t("label_feels_like"),
            value: formatUnit(feelsLike, t("unit_celsius"), 0),
          },
        ];
        heroStatsEl.innerHTML = stats
          .map(
            (stat) => `
              <div class="stat-card">
                <span>${stat.label}</span>
                <strong>${stat.value}</strong>
              </div>
            `,
          )
          .join("");

        heroCard.classList.remove("hidden");
      }

      function buildForecastCards(daily) {
        return daily.time
          .slice(1, 8)
          .map((date, offset) => {
            const index = offset + 1;
            const high = daily.temperature_2m_max?.[index];
            const low = daily.temperature_2m_min?.[index];
            const precip = daily.precipitation_probability_max?.[index];
            const code = daily.weathercode?.[index];
            const tempValue = `${formatValue(low, "¬∞C")} / ${formatValue(high, "¬∞C")}`;
            return `
              <div class="forecast-card">
                <div class="forecast-day">${formatDayLabel(date)}</div>
                <div class="forecast-date">${formatDate(date)}</div>
                <div class="forecast-icon">${weatherIcon(code)}</div>
                <div class="forecast-temp">${tempValue}</div>
                <div class="forecast-desc">${translateWeatherCode(code)}</div>
                <div class="forecast-rain">${t("rain_label", { value: formatValue(precip, "%") })}</div>
              </div>
            `;
          })
          .join("");
      }

      function buildForecastTable(daily) {
        const headers = [
          t("label_day"),
          t("label_weather"),
          t("label_temp_short"),
          t("label_rain_short"),
        ];
        const rows = daily.time.slice(1, 8).map((date, offset) => {
          const index = offset + 1;
          const high = daily.temperature_2m_max?.[index];
          const low = daily.temperature_2m_min?.[index];
          const precip = daily.precipitation_probability_max?.[index];
          const code = daily.weathercode?.[index];
          const tempValue = `${formatValue(low, t("unit_celsius"))} / ${formatValue(
            high,
            t("unit_celsius"),
          )}`;
          return `
            <tr>
              <td>
                <div class="forecast-cell-day">
                  ${formatDayLabel(date)}
                  <span>${formatDate(date)}</span>
                </div>
              </td>
              <td>
                <div class="forecast-cell-weather">
                  ${weatherIcon(code)}
                  <span>${translateWeatherCode(code)}</span>
                </div>
              </td>
              <td>
                <div class="forecast-temp-main">${tempValue}</div>
              </td>
              <td>${formatValue(precip, "%")}</td>
            </tr>
          `;
        });

        return `
          <table>
            <thead>
              <tr>
                ${headers.map((label) => `<th>${label}</th>`).join("")}
              </tr>
            </thead>
            <tbody>
              ${rows.join("")}
            </tbody>
          </table>
        `;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.textContent = t("status_loading");
        resultEl.innerHTML = "";
        resetHero();

        if (!selectedCountryCode || !selectedCityName) {
          statusEl.textContent =
            t("status_select_both");
          return;
        }

        try {
          const params = new URLSearchParams({
            city: selectedCityName,
            country: selectedCountryCode,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/forecast?${params.toString()}`);
          const data = await response.json();

          if (!response.ok) {
            statusEl.textContent =
              data.error || t("status_request_failed");
            return;
          }

          const location = data.location;
          statusEl.textContent =
            t("status_forecast_for", { city: location.name, country: location.country });
          buildHero(data.daily, location, deriveCurrent(data));
          forecastSubtitleEl.textContent =
            t("forecast_subtitle_for", { city: location.name, country: location.country });
          resultEl.innerHTML = buildForecastCards(data.daily);
          forecastTableEl.innerHTML = buildForecastTable(data.daily);
          forecastSection.classList.remove("hidden");
          writeSessionDefaults({
            lang: selectedLanguage,
            countryCode: location.country_code || selectedCountryCode,
            countryName: location.country || "",
            cityName: location.name || selectedCityName,
            admin1: location.admin1 ?? "",
          });
        } catch (error) {
          console.error(error);
          statusEl.textContent =
            t("status_unexpected");
        }
      });
    </script>
  </body>
</html>
