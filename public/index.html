<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weekly Forecast</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --accent: #f97316;
        --accent-2: #2563eb;
        --border: #e2e8f0;
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        --hero: linear-gradient(135deg, #1f8ae0 0%, #0c66c2 100%);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        color: var(--text);
        min-height: 100vh;
        background: linear-gradient(180deg, #f8fbff 0%, #eef4fb 100%);
        position: relative;
        overflow-x: hidden;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background:
          radial-gradient(circle at 12% 14%, rgba(147, 197, 253, 0.35) 0 170px, transparent 230px),
          radial-gradient(circle at 28% 20%, rgba(191, 219, 254, 0.35) 0 200px, transparent 260px),
          radial-gradient(circle at 78% 16%, rgba(147, 197, 253, 0.32) 0 190px, transparent 250px),
          radial-gradient(circle at 88% 32%, rgba(191, 219, 254, 0.32) 0 220px, transparent 290px),
          radial-gradient(circle at 18% 78%, rgba(147, 197, 253, 0.3) 0 240px, transparent 320px),
          radial-gradient(circle at 76% 76%, rgba(191, 219, 254, 0.3) 0 260px, transparent 340px);
        opacity: 0.9;
        filter: blur(1px);
      }
      main.app {
        max-width: 1120px;
        margin: 0 auto;
        padding: 28px 20px 48px;
      }
      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 22px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand-icon {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: #0ea5e9;
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }
      .brand-text {
        display: flex;
        flex-direction: column;
      }
      .brand-title {
        font-size: 18px;
        font-weight: 700;
      }
      .brand-subtitle {
        font-size: 12px;
        color: var(--muted);
      }
      .header-actions {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        justify-content: flex-end;
      }
      .lang-tabs {
        display: inline-flex;
        gap: 8px;
        padding: 4px;
        border-radius: 999px;
        background: transparent;
        box-shadow: none;
      }
      .lang-tabs button {
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        line-height: 1;
        height: 24px;
        min-width: 36px;
        border-radius: 999px;
        cursor: pointer;
        color: #64748b;
        box-shadow: none;
      }
      #lang-he {
        font-size: 12px;
      }
      .lang-tabs button.active {
        background: #1f8ae0;
        border-color: #1f8ae0;
        color: white;
      }
      .search-card {
        background: var(--card);
        border-radius: 18px;
        padding: 16px 20px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      .search-form {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)) auto;
        gap: 14px;
        align-items: center;
      }
      .search-form .field:last-child {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 18px;
      }
      .field label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--muted);
      }
      input {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #f8fafc;
      }
      .dropdown {
        position: relative;
      }
      .dropdown input {
        padding-right: 34px;
      }
      .dropdown .chevron {
        position: absolute;
        right: 12px;
        top: 33px;
        color: var(--muted);
        pointer-events: none;
      }
      body[dir="rtl"] .dropdown .chevron {
        right: auto;
        left: 12px;
      }
      .dropdown-list {
        position: absolute;
        z-index: 10;
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-top: 6px;
        max-height: 220px;
        overflow-y: auto;
        width: 100%;
        box-shadow: var(--shadow);
        display: none;
      }
      .dropdown-list.open {
        display: block;
      }
      .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
      }
      .dropdown-item:hover,
      .dropdown-item.active {
        background: #eff6ff;
      }
      button {
        padding: 8px 16px;
        font-size: 13px;
        border: none;
        border-radius: 12px;
        background: #d97035;
        color: white;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.2s ease;
        box-shadow: none;
        min-width: 120px;
        height: 34px;
      }
      button.cta {
        border-radius: 999px;
        padding: 8px 18px;
        box-shadow: none;
      }
      button:active {
        transform: translateY(1px);
      }
      .status {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }
      .hero-card {
        margin-top: 22px;
        background: var(--hero);
        color: white;
        border-radius: 22px;
        padding: 24px 28px;
        box-shadow: var(--shadow);
      }
      .hero-card.hidden {
        display: none;
      }
      .hero-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
      }
      .hero-city {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
      }
      .hero-country {
        margin: 4px 0;
        font-size: 14px;
        opacity: 0.8;
      }
      .hero-condition {
        margin: 16px 0 0;
        font-size: 14px;
        font-weight: 600;
      }
      .hero-temp {
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      body[dir="rtl"] .hero-temp {
        text-align: left;
        align-items: flex-start;
      }
      .hero-icon {
        font-size: 24px;
      }
      .hero-temp-value {
        font-size: 52px;
        font-weight: 700;
        line-height: 1;
      }
      .hero-temp-sub {
        font-size: 13px;
        opacity: 0.8;
      }
      .hero-stats {
        margin-top: 18px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.16);
        border-radius: 14px;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
      }
      .stat-card span {
        opacity: 0.75;
      }
      .stat-card strong {
        font-size: 15px;
        font-weight: 600;
      }
      .forecast-section {
        margin-top: 26px;
      }
      .forecast-section.hidden {
        display: none;
      }
      .section-header h2 {
        margin: 0;
        font-size: 20px;
      }
      .section-header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }
      .forecast-grid {
        margin-top: 16px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 14px;
      }
      .forecast-card {
        background: var(--card);
        border-radius: 16px;
        padding: 14px 12px;
        border: 1px solid var(--border);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06);
        text-align: center;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      .forecast-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
      }
      .forecast-card.today {
        border-color: #1d4ed8;
        background: linear-gradient(180deg, #0ea5e9 0%, #2563eb 100%);
        color: white;
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.3);
      }
      .forecast-card.today .forecast-day,
      .forecast-card.today .forecast-date,
      .forecast-card.today .forecast-desc {
        color: rgba(255, 255, 255, 0.85);
      }
      .forecast-day {
        font-size: 12px;
        color: var(--muted);
      }
      .forecast-date {
        font-size: 12px;
        margin-top: 4px;
        color: var(--muted);
      }
      .forecast-icon {
        margin: 14px 0;
        font-size: 22px;
      }
      .forecast-temp {
        font-size: 18px;
        font-weight: 600;
      }
      .forecast-desc {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .forecast-rain {
        margin-top: 4px;
        font-size: 11px;
        color: var(--muted);
      }
      .forecast-card.today .forecast-rain {
        color: rgba(255, 255, 255, 0.85);
      }
      .app-footer {
        margin-top: 30px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: center;
        text-align: center;
      }
      .footer-card {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 18px 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        min-width: 240px;
      }
      .footer-brand {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        color: var(--text);
      }
      .footer-brand .brand-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
      .footer-meta {
        font-size: 12px;
        color: var(--muted);
      }
      .footer-links {
        display: inline-flex;
        gap: 8px;
        color: var(--muted);
        font-size: 11px;
      }
      body[dir="rtl"] main.app {
        direction: rtl;
      }
      body[dir="rtl"] .footer-links {
        direction: rtl;
      }
      @media (max-width: 900px) {
        .hero-stats {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .app-footer {
          flex-direction: column;
          gap: 6px;
        }
      }
      @media (max-width: 720px) {
        main.app {
          padding: 20px 16px 36px;
        }
        .app-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .search-form {
          grid-template-columns: 1fr;
        }
        button {
          width: 100%;
        }
        .hero-main {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <header class="app-header">
        <div class="brand">
          <div class="brand-icon">ğŸŒ¦ï¸</div>
          <div class="brand-text">
            <span class="brand-title" id="brand-title">Weather</span>
            <span class="brand-subtitle" id="brand-subtitle">7-day forecast</span>
          </div>
        </div>
        <div class="header-actions">
          <div class="lang-tabs" role="tablist" aria-label="Language">
            <button id="lang-en" type="button" role="tab" aria-selected="true" class="active">
              EN
            </button>
            <button id="lang-he" type="button" role="tab" aria-selected="false">
              ×¢×‘
            </button>
          </div>
        </div>
      </header>

      <section class="search-card">
        <form id="forecast-form" class="search-form">
          <div class="field">
            <label for="country-search">Country</label>
            <div class="dropdown">
              <input
                id="country-search"
                placeholder="Type at least 2 letters"
                required
                autocomplete="off"
              />
              <span class="chevron">â–¾</span>
              <div id="country-list" class="dropdown-list"></div>
            </div>
          </div>
          <div class="field">
            <label for="city-search">City</label>
            <div class="dropdown">
              <input
                id="city-search"
                placeholder="Select a country first"
                disabled
                autocomplete="off"
              />
              <span class="chevron">â–¾</span>
              <div id="city-list" class="dropdown-list"></div>
            </div>
          </div>
          <div class="field">
            <button type="submit" class="cta">Get Forecast</button>
          </div>
        </form>
        <div id="status" class="status"></div>
      </section>

      <section class="hero-card hidden" id="hero-card">
        <div class="hero-main">
          <div>
            <h1 class="hero-city" id="hero-city">--</h1>
            <p class="hero-country" id="hero-country">--</p>
            <p class="hero-condition" id="hero-condition">--</p>
          </div>
          <div class="hero-temp">
            <div class="hero-icon" id="hero-icon">â›…</div>
            <div class="hero-temp-value" id="hero-temp">--</div>
            <div class="hero-temp-sub" id="hero-temp-sub">--</div>
          </div>
        </div>
        <div class="hero-stats" id="hero-stats"></div>
      </section>

      <section class="forecast-section hidden" id="forecast-section">
        <div class="section-header">
          <h2 id="forecast-title">7-Day Forecast</h2>
          <p id="forecast-subtitle">Weather outlook for your location.</p>
        </div>
        <div id="result" class="forecast-grid"></div>
      </section>

      <footer class="app-footer" id="footer-note">
        <div class="footer-card">
          <div class="footer-brand">
            <span class="brand-icon">ğŸŒ¦ï¸</span>
            <span id="footer-title">Weather Forecast</span>
          </div>
          <div class="footer-meta" id="footer-created">Created by Tzachi Cohen</div>
          <div class="footer-meta" id="footer-rights">All Rights Reserved 2026</div>
          <div class="footer-links">
            <span id="footer-privacy">Privacy Policy</span>
            <span>â€¢</span>
            <span id="footer-terms">Terms of Service</span>
            <span>â€¢</span>
            <span id="footer-contact">Contact</span>
          </div>
        </div>
      </footer>

    </main>

    <script>
      const form = document.getElementById("forecast-form");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const heroCard = document.getElementById("hero-card");
      const heroCityEl = document.getElementById("hero-city");
      const heroCountryEl = document.getElementById("hero-country");
      const heroConditionEl = document.getElementById("hero-condition");
      const heroTempEl = document.getElementById("hero-temp");
      const heroTempSubEl = document.getElementById("hero-temp-sub");
      const heroIconEl = document.getElementById("hero-icon");
      const heroStatsEl = document.getElementById("hero-stats");
      const forecastSection = document.getElementById("forecast-section");
      const forecastTitleEl = document.getElementById("forecast-title");
      const forecastSubtitleEl = document.getElementById("forecast-subtitle");
      const brandTitleEl = document.getElementById("brand-title");
      const brandSubtitleEl = document.getElementById("brand-subtitle");
      const footerTitleEl = document.getElementById("footer-title");
      const footerCreatedEl = document.getElementById("footer-created");
      const footerRightsEl = document.getElementById("footer-rights");
      const footerPrivacyEl = document.getElementById("footer-privacy");
      const footerTermsEl = document.getElementById("footer-terms");
      const footerContactEl = document.getElementById("footer-contact");
      const langEnButton = document.getElementById("lang-en");
      const langHeButton = document.getElementById("lang-he");
      const countrySearch = document.getElementById("country-search");
      const countryList = document.getElementById("country-list");
      const citySearch = document.getElementById("city-search");
      const cityList = document.getElementById("city-list");

      let allCountries = [];
      let selectedCountryCode = "";
      let selectedCityName = "";
      let locationDefaults = null;
      let rawLocationDefaults = null;
      let autoSubmitPending = false;

      function getDefaultLanguage() {
        const locale = (navigator.language || "").toLowerCase();
        const locales = Array.isArray(navigator.languages) ? navigator.languages : [];
        const combined = [locale, ...locales].join(",").toLowerCase();
        if (combined.includes("he") || combined.includes("he-il")) {
          return "he";
        }
        try {
          const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          if (timeZone && timeZone.toLowerCase() === "asia/jerusalem") {
            return "he";
          }
        } catch (error) {
          console.warn("Unable to detect time zone for language default:", error);
        }
        return "en";
      }

      let selectedLanguage = "en";

      async function getGeoDefaults() {
        if (!navigator.geolocation) {
          return null;
        }

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              (async () => {
                try {
                  const response = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&count=1&language=en&format=json`,
                  );
                  const data = await response.json();
                  const hit = data?.results?.[0];
                  if (!hit) {
                    resolve(null);
                    return;
                  }
                  resolve({
                    countryCode: hit.country_code?.toUpperCase() || "",
                    countryName: hit.country || "",
                    cityName: hit.name || "",
                    admin1: hit.admin1 ?? null,
                  });
                } catch (error) {
                  console.warn("Unable to reverse geocode location:", error);
                  resolve(null);
                }
              })();
            },
            (error) => {
              console.warn("Geolocation not available:", error);
              resolve(null);
            },
            { enableHighAccuracy: false, timeout: 6000, maximumAge: 300000 },
          );
        });
      }

      async function getIpDefaults() {
        try {
          const response = await fetch("https://ipapi.co/json/");
          const data = await response.json();
          if (!data) {
            return null;
          }
          return {
            countryCode: data.country_code ? data.country_code.toUpperCase() : "",
            countryName: data.country_name || "",
            cityName: data.city || "",
            admin1: data.region || null,
          };
        } catch (error) {
          console.warn("Unable to resolve IP location:", error);
          return null;
        }
      }

      async function localizeCityName(countryCode, cityName, lang) {
        if (!countryCode || !cityName || !lang) {
          return null;
        }
        try {
          const params = new URLSearchParams({
            name: cityName,
            count: "1",
            language: lang,
            format: "json",
            country: countryCode,
          });
          const response = await fetch(
            `https://geocoding-api.open-meteo.com/v1/search?${params.toString()}`,
          );
          const data = await response.json();
          const hit = data?.results?.[0];
          if (!hit) {
            return null;
          }
          return {
            cityName: hit.name || cityName,
            admin1: hit.admin1 ?? null,
          };
        } catch (error) {
          console.warn("Unable to localize city name:", error);
          return null;
        }
      }

      async function getLocationDefaults() {
        const geoDefaults = await getGeoDefaults();
        if (geoDefaults) {
          return geoDefaults;
        }
        return getIpDefaults();
      }

      async function loadCountries() {
        try {
          const response = await fetch(
            `/api/countries?lang=${encodeURIComponent(selectedLanguage)}&refresh=1`,
          );
          const data = await response.json();
          if (!response.ok) {
            statusEl.textContent =
              selectedLanguage === "he"
                ? data.error || "×˜×¢×™× ×ª ×”××“×™× ×•×ª × ×›×©×œ×”."
                : data.error || "Failed to load countries.";
            return;
          }

          const heDisplay = new Intl.DisplayNames(["he"], { type: "region" });
          const enDisplay = new Intl.DisplayNames(["en"], { type: "region" });

          allCountries = data.countries.map((country) => {
            const hebrewName = country.hebrewName || heDisplay.of(country.code);
            const englishName = country.englishName || enDisplay.of(country.code);
            return {
              ...country,
              englishName: englishName || country.name,
              hebrewName: hebrewName || country.name,
              name:
                selectedLanguage === "he"
                  ? hebrewName || country.name
                  : country.name || englishName,
            };
          });
        } catch (error) {
          console.error(error);
          statusEl.textContent =
            selectedLanguage === "he" ? "×˜×¢×™× ×ª ×”××“×™× ×•×ª × ×›×©×œ×”." : "Failed to load countries.";
        }
      }

      let cityFetchController = null;

      function openList(listEl) {
        listEl.classList.add("open");
      }

      function closeList(listEl) {
        listEl.classList.remove("open");
      }

      function applyLanguage() {
        const isHebrew = selectedLanguage === "he";
        document.documentElement.lang = isHebrew ? "he" : "en";
        document.body.dir = isHebrew ? "rtl" : "ltr";

        brandTitleEl.textContent = isHebrew ? "××–×’ ××•×•×™×¨" : "Weather";
        brandSubtitleEl.textContent = isHebrew ? "×ª×—×–×™×ª ×œ-7 ×™××™×" : "7-day forecast";
        document.querySelector("label[for='country-search']").textContent = isHebrew
          ? "××“×™× ×”"
          : "Country";
        document.querySelector("label[for='city-search']").textContent = isHebrew
          ? "×¢×™×¨"
          : "City";
        document.querySelector("button[type='submit']").textContent = isHebrew
          ? "×§×‘×œ ×ª×—×–×™×ª"
          : "Get Forecast";
        footerTitleEl.textContent = isHebrew ? "×ª×—×–×™×ª ××–×’ ××•×•×™×¨" : "Weather Forecast";
        footerCreatedEl.textContent = isHebrew ? "× ×•×¦×¨ ×¢×œ ×™×“×™ ×¦×—×™ ×›×”×Ÿ" : "Created by Tzachi Cohen";
        footerRightsEl.textContent = isHebrew
          ? "×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª 2026"
          : "All Rights Reserved 2026";
        footerPrivacyEl.textContent = isHebrew ? "××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª" : "Privacy Policy";
        footerTermsEl.textContent = isHebrew ? "×ª× ××™ ×©×™××•×©" : "Terms of Service";
        footerContactEl.textContent = isHebrew ? "×¦×•×¨ ×§×©×¨" : "Contact";
        forecastTitleEl.textContent = isHebrew ? "×ª×—×–×™×ª ×œ-7 ×™××™×" : "7-Day Forecast";
        langEnButton.classList.toggle("active", !isHebrew);
        langHeButton.classList.toggle("active", isHebrew);
        langEnButton.setAttribute("aria-selected", String(!isHebrew));
        langHeButton.setAttribute("aria-selected", String(isHebrew));

        countrySearch.placeholder = isHebrew
          ? "×”×§×œ×“ ×œ×¤×—×•×ª 2 ××•×ª×™×•×ª"
          : "Type at least 2 letters";
        citySearch.placeholder = selectedCountryCode
          ? isHebrew
            ? "×”×§×œ×“ ×œ×¤×—×•×ª 2 ××•×ª×™×•×ª"
            : "Type at least 2 letters"
          : isHebrew
            ? "×‘×—×¨ ××“×™× ×” ×ª×—×™×œ×”"
            : "Select a country first";
      }

      function translateWeatherCode(code) {
        if (selectedLanguage !== "he") {
          return weatherCodeMap[code] || "Unknown";
        }
        const hebrewMap = {
          0: "×©××™×™× ×‘×”×™×¨×™×",
          1: "×‘×”×™×¨ ×‘×¢×™×§×¨",
          2: "××¢×•× ×Ÿ ×—×œ×§×™×ª",
          3: "××¢×•× ×Ÿ",
          45: "×¢×¨×¤×œ",
          48: "×¢×¨×¤×œ ×§×¨×—",
          51: "×˜×¤×˜×•×£ ×§×œ",
          53: "×˜×¤×˜×•×£ ×‘×™× ×•× ×™",
          55: "×˜×¤×˜×•×£ ×›×‘×“",
          56: "×˜×¤×˜×•×£ ×§×¤×•× ×§×œ",
          57: "×˜×¤×˜×•×£ ×§×¤×•× ×›×‘×“",
          61: "×’×©× ×§×œ",
          63: "×’×©× ×‘×™× ×•× ×™",
          65: "×’×©× ×›×‘×“",
          66: "×’×©× ×§×•×¤× ×§×œ",
          67: "×’×©× ×§×•×¤× ×›×‘×“",
          71: "×©×œ×’ ×§×œ",
          73: "×©×œ×’ ×‘×™× ×•× ×™",
          75: "×©×œ×’ ×›×‘×“",
          77: "×’×¨×’×¨×™ ×©×œ×’",
          80: "×××˜×¨×™× ×§×œ×™×",
          81: "×××˜×¨×™× ×‘×™× ×•× ×™×™×",
          82: "×××˜×¨×™× ×—×–×§×™×",
          85: "×××˜×¨×™ ×©×œ×’ ×§×œ×™×",
          86: "×××˜×¨×™ ×©×œ×’ ×—×–×§×™×",
          95: "×¡×•×¤×ª ×¨×¢××™×",
          96: "×¡×•×¤×ª ×¨×¢××™× ×¢× ×‘×¨×“ ×§×œ",
          99: "×¡×•×¤×ª ×¨×¢××™× ×¢× ×‘×¨×“ ×›×‘×“",
        };
        return hebrewMap[code] || "×œ× ×™×“×•×¢";
      }

      function weatherIcon(code) {
        if (code === 0) return "â˜€ï¸";
        if (code === 1) return "ğŸŒ¤ï¸";
        if (code === 2) return "â›…";
        if (code === 3) return "â˜ï¸";
        if (code === 45 || code === 48) return "ğŸŒ«ï¸";
        if (code >= 51 && code <= 57) return "ğŸŒ¦ï¸";
        if (code >= 61 && code <= 67) return "ğŸŒ§ï¸";
        if (code >= 71 && code <= 77) return "ğŸŒ¨ï¸";
        if (code >= 80 && code <= 82) return "ğŸŒ¦ï¸";
        if (code >= 85 && code <= 86) return "â„ï¸";
        if (code >= 95) return "â›ˆï¸";
        return "ğŸŒ¡ï¸";
      }

      function setCountrySelection(country) {
        countrySearch.value = `${country.name} (${country.code})`;
        selectedCountryCode = country.code;
        closeList(countryList);
        citySearch.disabled = false;
        citySearch.placeholder =
          selectedLanguage === "he" ? "×”×§×œ×“ ×œ×¤×—×•×ª 2 ××•×ª×™×•×ª" : "Type at least 2 letters";
        citySearch.value = "";
        selectedCityName = "";
        cityList.innerHTML = "";
      }

      function setCitySelection(city) {
        citySearch.value = city.admin1 ? `${city.name} (${city.admin1})` : city.name;
        selectedCityName = city.name;
        closeList(cityList);
        if (autoSubmitPending) {
          autoSubmitPending = false;
          submitIfReady();
        }
      }

      function renderCountryList(matches) {
        countryList.innerHTML = "";
        matches.forEach((country) => {
          const item = document.createElement("div");
          item.className = "dropdown-item";
          item.textContent = `${country.name} (${country.code})`;
          item.addEventListener("mousedown", (event) => {
            event.preventDefault();
            setCountrySelection(country);
          });
          countryList.appendChild(item);
        });
        if (matches.length > 0) {
          openList(countryList);
        } else {
          closeList(countryList);
        }
      }

      function applyLocationDefaults() {
        if (!locationDefaults) {
          return;
        }

        const { countryCode, countryName, cityName, admin1 } = locationDefaults;
        let countryMatch = null;
        if (countryCode) {
          countryMatch = allCountries.find((country) => country.code === countryCode);
        }
        if (!countryMatch && countryName) {
          const normalized = countryName.toLowerCase();
          countryMatch = allCountries.find((country) => {
            const english = country.englishName?.toLowerCase();
            const hebrew = country.hebrewName?.toLowerCase();
            return (
              country.name.toLowerCase() === normalized ||
              (english && english === normalized) ||
              (hebrew && hebrew === normalized)
            );
          });
        }
        if (countryMatch) {
          setCountrySelection(countryMatch);
        } else if (countryCode || countryName) {
          setCountrySelection({
            code: countryCode || countryName,
            name: countryName || countryCode,
            englishName: countryName || countryCode,
            hebrewName: countryName || countryCode,
          });
        }

        if (selectedCountryCode && cityName) {
          setCitySelection({ name: cityName, admin1 });
        }
      }

      function resetHero() {
        heroCityEl.textContent = "--";
        heroCountryEl.textContent = "--";
        heroConditionEl.textContent = "--";
        heroTempEl.textContent = "--";
        heroTempSubEl.textContent = "--";
        heroIconEl.textContent = "â›…";
        heroStatsEl.innerHTML = "";
        heroCard.classList.add("hidden");
        forecastSection.classList.add("hidden");
        forecastSubtitleEl.textContent =
          selectedLanguage === "he"
            ? "×ª×—×–×™×ª ××–×’ ××•×•×™×¨ ×œ××™×§×•× ×©×œ×š."
            : "Weather outlook for your location.";
      }

      function submitIfReady() {
        if (!selectedCountryCode || !selectedCityName) {
          return;
        }
        if (typeof form.requestSubmit === "function") {
          form.requestSubmit();
        } else {
          form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        }
      }


      function getCountryMatches(query) {
        const normalized = query.toLowerCase();
        return allCountries
          .filter((country) => {
            const nameMatch = country.name.toLowerCase().includes(normalized);
            const codeMatch = country.code.toLowerCase().includes(normalized);
            const englishMatch = country.englishName
              ? country.englishName.toLowerCase().includes(normalized)
              : false;
            const hebrewMatch = country.hebrewName
              ? country.hebrewName.toLowerCase().includes(normalized)
              : false;
            const altMatch = Array.isArray(country.altSpellings)
              ? country.altSpellings.some((alt) =>
                  alt.toLowerCase().includes(normalized),
                )
              : false;
            return nameMatch || codeMatch || englishMatch || hebrewMatch || altMatch;
          })
          .slice(0, 50);
      }

      let countryFetchController = null;

      async function fetchCountryMatches(query) {
        if (countryFetchController) {
          countryFetchController.abort();
        }

        countryFetchController = new AbortController();
        try {
          const params = new URLSearchParams({
            query,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/countries/search?${params.toString()}`, {
            signal: countryFetchController.signal,
          });
          const data = await response.json();
          if (!response.ok) {
            return [];
          }
          return Array.isArray(data.countries) ? data.countries : [];
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
          }
          return [];
        }
      }

      async function renderCityList(countryCode, query) {
        if (query.length < 2) {
          closeList(cityList);
          return;
        }

        if (cityFetchController) {
          cityFetchController.abort();
        }

        cityFetchController = new AbortController();
        try {
          const params = new URLSearchParams({
            country: countryCode,
            query,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/cities?${params.toString()}`, {
            signal: cityFetchController.signal,
          });
          const data = await response.json();
          if (!response.ok) {
            closeList(cityList);
            return;
          }

          cityList.innerHTML = "";
          data.cities.forEach((city) => {
            const item = document.createElement("div");
            item.className = "dropdown-item";
            item.textContent = city.admin1
              ? `${city.name} (${city.admin1})`
              : city.name;
            item.addEventListener("mousedown", (event) => {
              event.preventDefault();
              setCitySelection(city);
            });
            cityList.appendChild(item);
          });
          if (data.cities.length > 0) {
            openList(cityList);
          } else {
            closeList(cityList);
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
          }
        }
      }

      async function switchLanguage(nextLang) {
        if (nextLang === selectedLanguage) {
          return;
        }
        selectedLanguage = nextLang;
        selectedCountryCode = "";
        selectedCityName = "";
        countrySearch.value = "";
        citySearch.value = "";
        citySearch.disabled = true;
        cityList.innerHTML = "";
        countryList.innerHTML = "";
        statusEl.textContent = "";
        resultEl.innerHTML = "";
        resetHero();
        applyLocalizedDefaults(selectedLanguage);
        if (locationDefaults?.cityName) {
          const localized = await localizeCityName(
            locationDefaults.countryCode,
            locationDefaults.cityName,
            selectedLanguage,
          );
          if (localized) {
            locationDefaults = {
              ...locationDefaults,
              cityName: localized.cityName,
              admin1: localized.admin1,
            };
          }
        }
        applyLanguage();
        await loadCountries();
        autoSubmitPending = true;
        applyLocationDefaults();
        submitIfReady();
      }

      langEnButton.addEventListener("click", () => {
        switchLanguage("en");
      });

      langHeButton.addEventListener("click", () => {
        switchLanguage("he");
      });

      resetHero();

      countrySearch.addEventListener("input", async (event) => {
        const query = event.target.value.trim();
        selectedCountryCode = "";
        selectedCityName = "";
        citySearch.value = "";
        citySearch.disabled = true;
        citySearch.placeholder =
          selectedLanguage === "he" ? "×‘×—×¨ ××“×™× ×” ×ª×—×™×œ×”" : "Select a country first";
        cityList.innerHTML = "";

        if (query.length < 2) {
          closeList(countryList);
          return;
        }
        let matches = getCountryMatches(query);
        if (matches.length === 0 && selectedLanguage === "he") {
          matches = await fetchCountryMatches(query);
        }
        renderCountryList(matches);
      });

      countrySearch.addEventListener("focus", async () => {
        if (countrySearch.value.trim().length >= 2) {
          let matches = getCountryMatches(countrySearch.value.trim());
          if (matches.length === 0 && selectedLanguage === "he") {
            matches = await fetchCountryMatches(countrySearch.value.trim());
          }
          renderCountryList(matches);
        }
      });

      citySearch.addEventListener("input", (event) => {
        if (!selectedCountryCode) {
          return;
        }
        renderCityList(selectedCountryCode, event.target.value.trim());
      });

      citySearch.addEventListener("focus", () => {
        if (!selectedCountryCode) {
          return;
        }
        if (citySearch.value.trim().length >= 2) {
          renderCityList(selectedCountryCode, citySearch.value.trim());
        }
      });

      document.addEventListener("click", (event) => {
        if (!countrySearch.contains(event.target) && !countryList.contains(event.target)) {
          closeList(countryList);
        }
        if (!citySearch.contains(event.target) && !cityList.contains(event.target)) {
          closeList(cityList);
        }
      });

      closeList(countryList);
      closeList(cityList);
      function applyLocalizedDefaults(targetLang) {
        if (!rawLocationDefaults) {
          locationDefaults = null;
          return;
        }
        if (targetLang === "en") {
          locationDefaults = { ...rawLocationDefaults };
          return;
        }
        if (!rawLocationDefaults.cityName) {
          locationDefaults = { ...rawLocationDefaults };
          return;
        }
        locationDefaults = { ...rawLocationDefaults };
      }
      async function initApp() {
        rawLocationDefaults = await getLocationDefaults();
        if (rawLocationDefaults?.countryCode === "IL") {
          selectedLanguage = "he";
        } else {
          selectedLanguage = getDefaultLanguage();
        }
        applyLocalizedDefaults(selectedLanguage);
        if (locationDefaults?.cityName) {
          const localized = await localizeCityName(
            locationDefaults.countryCode,
            locationDefaults.cityName,
            selectedLanguage,
          );
          if (localized) {
            locationDefaults = {
              ...locationDefaults,
              cityName: localized.cityName,
              admin1: localized.admin1,
            };
          }
        }
        applyLanguage();
        await loadCountries();
        autoSubmitPending = true;
        applyLocationDefaults();
        submitIfReady();
      }
      initApp();

      const weatherCodeMap = {
        0: "Clear sky",
        1: "Mainly clear",
        2: "Partly cloudy",
        3: "Overcast",
        45: "Fog",
        48: "Depositing rime fog",
        51: "Drizzle: light",
        53: "Drizzle: moderate",
        55: "Drizzle: dense",
        56: "Freezing drizzle: light",
        57: "Freezing drizzle: dense",
        61: "Rain: slight",
        63: "Rain: moderate",
        65: "Rain: heavy",
        66: "Freezing rain: light",
        67: "Freezing rain: heavy",
        71: "Snow: slight",
        73: "Snow: moderate",
        75: "Snow: heavy",
        77: "Snow grains",
        80: "Rain showers: slight",
        81: "Rain showers: moderate",
        82: "Rain showers: violent",
        85: "Snow showers: slight",
        86: "Snow showers: heavy",
        95: "Thunderstorm",
        96: "Thunderstorm with slight hail",
        99: "Thunderstorm with heavy hail",
      };

      function formatValue(value, suffix = "") {
        if (value === null || value === undefined || Number.isNaN(value)) {
          return selectedLanguage === "he" ? "×œ× ×™×“×•×¢" : "Unknown";
        }
        return `${value}${suffix}`;
      }

      function formatDate(dateString) {
        if (!dateString) {
          return "";
        }
        const parts = dateString.split("-");
        if (parts.length !== 3) {
          return dateString;
        }
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      }

      function formatDayLabel(dateString) {
        const date = new Date(`${dateString}T00:00:00`);
        const locale = selectedLanguage === "he" ? "he-IL" : "en-US";
        return date.toLocaleDateString(locale, { weekday: "short" });
      }

      function buildHero(daily, location) {
        const todayHigh = daily.temperature_2m_max?.[0];
        const todayLow = daily.temperature_2m_min?.[0];
        const precip = daily.precipitation_probability_max?.[0];
        const code = daily.weathercode?.[0];
        const condition = translateWeatherCode(code);
        const isHebrew = selectedLanguage === "he";

        heroCityEl.textContent = location?.name || "--";
        heroCountryEl.textContent = location?.country || "--";
        heroConditionEl.textContent = condition;
        heroIconEl.textContent = weatherIcon(code);
        heroTempEl.textContent = formatValue(todayHigh, "Â°C");
        heroTempSubEl.textContent = isHebrew
          ? `× ××•×š ${formatValue(todayLow, "Â°C")} / ×’×‘×•×” ${formatValue(todayHigh, "Â°C")}`
          : `Low ${formatValue(todayLow, "Â°C")} / High ${formatValue(todayHigh, "Â°C")}`;

        const stats = [
          {
            label: isHebrew ? "×¡×™×›×•×™ ×œ×’×©×" : "Rain chance",
            value: formatValue(precip, "%"),
          },
          {
            label: isHebrew ? "×˜××¤×¨×˜×•×¨×”" : "Temperature",
            value: `${formatValue(todayLow, "Â°C")} / ${formatValue(todayHigh, "Â°C")}`,
          },
          {
            label: isHebrew ? "×ª××¨×™×š" : "Date",
            value: formatDate(daily.time?.[0]),
          },
          {
            label: isHebrew ? "×ª× ××™×" : "Conditions",
            value: condition,
          },
        ];
        heroStatsEl.innerHTML = stats
          .map(
            (stat) => `
              <div class="stat-card">
                <span>${stat.label}</span>
                <strong>${stat.value}</strong>
              </div>
            `,
          )
          .join("");

        heroCard.classList.remove("hidden");
      }

      function buildForecastCards(daily) {
        return daily.time
          .map((date, index) => {
            const high = daily.temperature_2m_max?.[index];
            const low = daily.temperature_2m_min?.[index];
            const precip = daily.precipitation_probability_max?.[index];
            const code = daily.weathercode?.[index];
            const isToday = index === 0;
            const tempValue = `${formatValue(low, "Â°C")} / ${formatValue(high, "Â°C")}`;
            return `
              <div class="forecast-card ${isToday ? "today" : ""}">
                <div class="forecast-day">${formatDayLabel(date)}</div>
                <div class="forecast-date">${formatDate(date)}</div>
                <div class="forecast-icon">${weatherIcon(code)}</div>
                <div class="forecast-temp">${tempValue}</div>
                <div class="forecast-desc">${translateWeatherCode(code)}</div>
                <div class="forecast-rain">${
                  selectedLanguage === "he"
                    ? `${formatValue(precip, "%")} ×’×©×`
                    : `${formatValue(precip, "%")} rain`
                }</div>
              </div>
            `;
          })
          .join("");
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.textContent = selectedLanguage === "he" ? "×˜×•×¢×Ÿ..." : "Loading...";
        resultEl.innerHTML = "";
        resetHero();

        if (!selectedCountryCode || !selectedCityName) {
          statusEl.textContent =
            selectedLanguage === "he"
              ? "×× × ×‘×—×¨ ××“×™× ×” ×•×¢×™×¨."
              : "Please select both country and city.";
          return;
        }

        try {
          const params = new URLSearchParams({
            city: selectedCityName,
            country: selectedCountryCode,
            lang: selectedLanguage,
          });
          const response = await fetch(`/api/forecast?${params.toString()}`);
          const data = await response.json();

          if (!response.ok) {
            statusEl.textContent =
              selectedLanguage === "he"
                ? data.error || "×”×‘×§×©×” × ×›×©×œ×”."
                : data.error || "Request failed.";
            return;
          }

          const location = data.location;
          statusEl.textContent =
            selectedLanguage === "he"
              ? `×ª×—×–×™×ª ×¢×‘×•×¨ ${location.name}, ${location.country}`
              : `Forecast for ${location.name}, ${location.country}`;
          buildHero(data.daily, location);
          forecastSubtitleEl.textContent =
            selectedLanguage === "he"
              ? `×ª×—×–×™×ª ×¢×‘×•×¨ ${location.name}, ${location.country}`
              : `Weather outlook for ${location.name}, ${location.country}`;
          resultEl.innerHTML = buildForecastCards(data.daily);
          forecastSection.classList.remove("hidden");
        } catch (error) {
          console.error(error);
          statusEl.textContent =
            selectedLanguage === "he"
              ? "×©×’×™××” ×œ× ×¦×¤×•×™×”. × ×¡×” ×©×•×‘."
              : "Unexpected error. Please try again.";
        }
      });
    </script>
  </body>
</html>
